<!-- creditos-views-credito.xml -->
<odoo>
    <!-- Acción de Menú (DEBE IR PRIMERO) -->
    <record id="credito_asignaciones" model="ir.actions.act_window">
        <field name="name">Asignaciones</field>
        <field name="res_model">creditos.credito</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Crea tu primer asignacion</p>
        </field>
    </record>

    <!-- Vista árbol -->
    <record id="view_solicitudes_list" model="ir.ui.view">
        <field name="name">asignacion.list</field>
        <field name="model">creditos.credito</field>
        <field name="arch" type="xml">
            <list>
                <field name="dictamen" widget="badge" decoration-success="dictamen == 'confirmed'" decoration-danger="dictamen == 'discard'"
                    decoration-warning="dictamen == 'blocked'" decoration-muted="dictamen == 'tech' or dictamen == 'draft'" decoration-info="dictamen == 'check'"/>
                <field name="folio" readonly="1"/>
                <field name="cliente"/>
                <field name="contrato"/>
                <field name="monto"/>
                <field name="superficie"/>
                <field name="saldo"/>
                <field name="currency_id" invisible="1"/>
            </list>
        </field>
    </record>

    <record id="action_creditos_draft" model="ir.actions.act_window">
        <field name="name">Solicitudes de crédito</field>
        <field name="res_model">creditos.credito</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_solicitudes_list"/>
        <field name="domain">[('dictamen', '=', 'draft')]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Genera solicitudes de créditos!</p>
        </field>
    </record>
    
    <record id="view_contrato_list" model="ir.ui.view">
        <field name="name">contrato.list</field>
        <field name="model">creditos.credito</field>
        <field name="arch" type="xml">
            <list>
                <field name="dictamen" widget="badge" decoration-success="dictamen == 'confirmed'" decoration-danger="dictamen == 'discard'"
                    decoration-warning="dictamen == 'blocked'" decoration-muted="dictamen == 'tech' or dictamen == 'draft'" decoration-info="dictamen == 'check'"/>
                <field name="foliocredito" readonly="1"/>
                <field name="cliente"/>
                <field name="contrato"/>
                <field name="monto"/>
                <field name="superficie"/>
                <field name="saldo"/>
                <field name="currency_id" invisible="1"/>
            </list>
        </field>
    </record>

    <record id="action_creditos" model="ir.actions.act_window">
        <field name="name">Solicitudes de crédito</field>
        <field name="res_model">creditos.credito</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_contrato_list"/>
        <field name="domain">[('dictamen', '!=', 'draft')]</field>
    </record>
    
    <record id="view_credito_detail" model="ir.ui.view">
        <field name="name">asignacion.form</field>
        <field name="model">creditos.credito</field>
        <field name="arch" type="xml">
            <form autosave="False">
                <header>
                    <button name="action_entry_draft" string="Sugerir correciones" type="object" class="btn btn-primary" icon="fa-rotate" invisible="dictamen != 'check'"/>
                    <button name="action_entry_confirmed" string="Autorizar" type="object" class="btn btn-primary" icon="fa-thumbs-up" invisible="dictamen != 'check'"/>
                    <button name="action_entry_discard" string="Rechazar" type="object" class="btn btn-primary" icon="fa-thumbs-down" invisible="dictamen != 'check'"/>
                    <button name="action_entry_check" string="Enviar a Comité" type="object" class="btn btn-primary" invisible="dictamen != 'draft' or not id"  confirm="¿Desea enviar la solicitud a comité?"/>
                    <button name="action_entry_bloked" string="Bloquear" type="object" class="btn btn-primary" icon="fa-lock" invisible="dictamen != 'confirmed'"/>
                    <button name="action_entry_open" string="Habilitar" type="object"  class="btn btn-primary" icon="fa-unlock" invisible="dictamen != 'bloked'"/>
                    <button name="action_entry_tech" string="Dictamen técnico" type="object"  class="btn btn-primary" icon="fa-comment-o" invisible="not id"/>

                    <field name="dictamen" widget="statusbar" statusbar_visible="draft,check,confirmed,discard,bloked" invisible="not id"/>
                </header>
                <group>
                <!-- contenedor que Odoo interpreta (group) -->
                <div style="display:flex; gap:1rem; align-items:flex-start; width:100%;" invisible = "dictamen != 'confirmed'">
                    <div style="flex:1; min-width:140px;">
                        <label for="capital"/>
                        <field name="capital" nolabel="1" style="font-weight: bold;"/>
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label for="interes"/>
                        <field name="interes" nolabel="1" style="font-weight: bold;"/>
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label for="pagos"/>
                        <field name="pagos" nolabel="1" style="font-weight: bold;"/>
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label for="saldo"/>
                        <field name="saldo" nolabel="1" style="font-weight: bold;"/>
                    </div>
                </div>
                </group>
                <sheet>
                    <group>
                        <group>
                            <field name="foliocredito" readonly="1" style="font-size: 16px; font-weight: bold" invisible="dictamen == 'draft'"/>
                            <field name="folio" invisible = "dictamen != 'draft' or not id"/>
                            <field name="cliente"/>
                            <field name="contrato"/>
                            <field name="titularr" invisible="tipocredito == '2'"/>
                            <field name="monto" invisible = "tipocredito == '2'"/>
                            <field name="usermonto" invisible = "tipocredito != '2'"/>
                            <field name="total_garantias" invisible="tipocredito != '0'"/>
                            <field name="vencimiento" invisible = "tipocredito == '2'"/>
                            <field name ="uservencimiento" invisible = "tipocredito != '2'"/>
                            <field name="superficie" invisible="tipocredito != '0'" />
                            <field name="usersuperficie" invisible="tipocredito != '1'" />
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>
                    <group name="datos_obligado" string="Obligado Solidario" invisible = "(titularr and cliente_estado_civil != 'casado') or tipocredito == '2'">
                        <div class="o_row" invisible="not cliente">
                            <field name="cliente_estado_civil" readonly="1"/>
                            <field name="cliente_conyugue" readonly="1" invisible="cliente_estado_civil not in ['casado', 'union_libre']"/>
                        </div>
                        <field name="obligado" readonly="not cliente or not contrato"/>
                        <field name="obligadodomicilio" readonly="not cliente or not contrato"/>
                        <field name="obligadoRFC" readonly="not cliente or not contrato"/>
                    </group>

                    <field name="tipocredito" invisible="1"/>
                    <notebook invisible="tipocredito != '0' or not tipocredito">
                        <page string="Predios" name="page_predios">
                            <button name="action_add_predios" string="Añadir" type="object" class="btn btn-primary" icon="fa-plus-circle" invisible="dictamen != 'draft'"/>
                            <field name="predios" readonly="not cliente or not contrato">
                                <list create="false" edit="false">
                                    <field name="credito_id" column_invisible="1"/>
                                    <field name="superficie"/>
                                    <field name="superficiecultivable" widget="badge" decoration-info="superficiecultivable"/>
                                    <field name="nocertificado"/>
                                    <field name="titular"/>
                                    <field name="localidad"/>
                                </list>
                            </field>
                        </page>
                        <page string="Garantías" name="page_garantias">
                            <button name="action_add_garantias" string="Añadir" type="object" class="btn btn-primary" icon="fa-plus-circle" invisible="dictamen != 'draft'"/>
                            <field name="garantias" readonly="not cliente or not contrato">
                                <list create="false" edit="false">
                                    <field name="credito_id" column_invisible="1"/>
                                    <field name="fecha_entrega"/>
                                    <field name="folio"/>
                                    <field name="tipo"/>
                                    <field name="descripcion"/>
                                    <field name="valor"/>
                                    <field name="currency_id" invisible="1"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_load_lineas" model="ir.actions.act_window">
        <field name="name">Líneas de Crédito</field>
        <field name="res_model">contratos.contrato</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'contratos.contrato.view_contratos_tree',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <record id="action_load_ciclos" model="ir.actions.act_window">
        <field name="name">Ciclos</field>
        <field name="res_model">ciclos.ciclo</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'ciclos.ciclo.view_ciclo_list',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <record id="action_load_cultivos" model="ir.actions.act_window">
        <field name="name">Cultivos</field>
        <field name="res_model">cultivos.cultivo</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'cultivos.cultivo.view_cultivo_list',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <record id="action_load_cargos" model="ir.actions.act_window">
        <field name="name">Cargos por Créditos</field>
        <field name="res_model">cargos.cargo</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'cargos.cargo.view_cargos_tree',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <record id="action_load_ejidos" model="ir.actions.act_window">
        <field name="name">Lista de ejidos</field>
        <field name="res_model">ejidos.ejido</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'ejidos.ejido.view_ejidos_list',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <record id="action_load_garantias" model="ir.actions.act_window">
        <field name="name">Garantías</field>
        <field name="res_model">creditos.garantia</field> 
        <field name="view_mode">list,form</field> 
        <field name="views" eval="[(False, 'tree'), (False, 'form')]"/> 
        <field name="context">{
            'list_view_ref': 'creditos.garantia.view_garantia_list',
            'default_view_mode': 'list' 
        }</field>
    </record>

    <menuitem id="menu_root" name="Solicitudes de Crédito" sequence="10" action="action_creditos_draft"/>
    <menuitem id="menu_contratos" name="Contratos" parent="menu_root" sequence="20" action="action_creditos"/>
    <menuitem id="menu_lineas" name="Líneas" parent="menu_root" sequence="30" action="action_load_lineas"/>
    <menuitem id="menu_garantias" name="Padrón de Garantías" parent="menu_root" sequence="40" action="action_load_garantias"/>
    <menuitem id="menu_catalogo" name="Catálogo" parent="menu_root" sequence="50"/>
        <menuitem id="menu_cargos" name="Cargos por Crédito" parent="menu_catalogo" action="action_load_cargos"/>
        <menuitem id="menu_ciclos" name="Ciclos Agrícolas" parent="menu_catalogo" action="action_load_ciclos"/>
        <menuitem id="menu_cultivos" name="Cultivos Agrícolas" parent="menu_catalogo" action="action_load_cultivos"/>
        <menuitem id="menu_ejidos" name="Ejidos" parent="menu_catalogo" action="action_load_ejidos"/>
</odoo>