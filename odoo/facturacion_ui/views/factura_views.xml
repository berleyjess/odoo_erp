<odoo>

  <!-- LIST: decoraciones y badge; SIN attrs -->
  <record id="view_factura_list18" model="ir.ui.view">
    <field name="name">facturas.factura.list18</field>
    <field name="model">facturas.factura</field>
    <field name="arch" type="xml">
      <list string="Facturas"
            decoration-success="state == 'stamped' and (saldo == 0.0 or not saldo)"
            decoration-warning="state == 'ready'"
            decoration-danger="state == 'canceled'"
            decoration-info="state == 'draft'">
        <field name="fecha"/>
        <field name="empresa_id"/>
        <field name="sucursal_id"/>
        <field name="cliente_id"/>
        <field name="tipo" widget="badge"/>
        <field name="metodo"/>
        <field name="forma"/>
        <field name="importe_total" string="Importe"/>
        <field name="saldo"/>
        <field name="origin_factura_id" invisible="not (tipo == 'E' or tipo == 'P')"/>
        <field name="state" widget="badge"/>
        <field name="uuid"/>
        <button name="action_fetch_xml_from_sw" type="object" icon="fa-download" string="XML" invisible="not uuid"/>
      </list>
    </field>
  </record>

  <record id="view_factura_kanban18" model="ir.ui.view">
    <field name="name">facturas.factura.kanban18</field>
    <field name="model">facturas.factura</field>
    <field name="arch" type="xml">
      <kanban default_group_by="state" class="o_kanban_small_column">
        <!-- ğŸ‘‡ DECLARACIÃ“N DE CAMPOS NECESARIOS -->
        <field name="tipo"/>
        <field name="uuid"/>
        <field name="state"/>
        <field name="cliente_id"/>
        <field name="sucursal_id"/>
        <field name="importe_total"/>
        <field name="saldo"/>
        <field name="fecha"/>

        <templates>
          <t t-name="kanban-box">
            <div class="o_kanban_record oe_kanban_global_click factura-card">
              <div class="kb-top">
                <span class="o_badge o_badge_secondary" t-esc="record.tipo.value"/>
                <t t-if="record.uuid.value">
                  <span class="o_badge o_badge_info">UUID</span>
                </t>
                <t t-set="st" t-value="record.state and record.state.raw_value"/>
                <span t-attf-class="o_badge
                  #{st=='stamped'  ? ' o_badge_success'  : ''}
                  #{st=='ready'    ? ' o_badge_warning'  : ''}
                  #{st=='canceled' ? ' o_badge_danger'   : ''}
                  #{st=='draft'    ? ' o_badge_secondary': ''}">
                  <t t-esc="record.state.value"/>
                </span>
              </div>

              <div class="kb-body">
                <div class="kb-left">
                  <div class="o_text_overflow"><i class="fa fa-user me-1"/> <t t-esc="record.cliente_id.value"/></div>
                  <div class="o_text_overflow"><i class="fa fa-home me-1"/> <t t-esc="record.sucursal_id.value"/></div>
                </div>
                <div class="kb-right">
                  <div class="amount"><span>Importe:</span> <t t-esc="record.importe_total.value"/></div>
                  <div class="amount"><span>Saldo:</span>   <t t-esc="record.saldo.value"/></div>
                </div>
              </div>

              <div class="kb-bottom">
                <span class="text-muted"><t t-esc="record.fecha.value"/></span>
                <div class="kb-actions">
                  <a type="edit" class="btn btn-link o_kanban_manage_button">Abrir</a>
                  <a t-if="record.uuid.value" type="object" name="action_fetch_xml_from_sw" class="btn btn-link">XML</a>
                </div>
              </div>
            </div>
          </t>
        </templates>
      </kanban>
    </field>
  </record>


  <!-- FORM: solo retoques visuales; SIN attrs -->
  <record id="view_factura_form18" model="ir.ui.view">
    <field name="name">facturas.factura.form18</field>
    <field name="model">facturas.factura</field>
    <field name="arch" type="xml">
      <form string="Captura de Factura">
        <header>
          <button name="action_build_and_stamp" type="object" string="Timbrar" class="btn-primary" invisible="state != 'draft'"/>
          <button name="action_fetch_xml_from_sw" type="object" string="Recuperar XML de SW" class="btn-warning" invisible="not uuid"/>
          <button name="action_prepare_credit_note" type="object" string="Nota de CrÃ©dito" class="btn-secondary" invisible="not (tipo == 'I' and state == 'stamped')"/>
          <button name="action_prepare_payment" type="object" string="Registrar Pago (Complemento)" class="oe_highlight" invisible="not (tipo == 'I' and state == 'stamped' and saldo &gt; 0.0)"/>
          <button name="action_cancel" type="object" string="Cancelar" class="btn-danger" context="{'cfdi_cancel_reason': '02'}" invisible="not (state == 'ready' or state == 'stamped')"/>
          <button name="action_close_form" type="object" string="Cerrar" class="btn-secondary"/>
          <field name="state" widget="statusbar" statusbar_visible="draft,ready,stamped,canceled"/>
        </header>

        <sheet>
          <div class="oe_button_box" name="button_box">
            <button name="action_open_attachments" type="object" class="oe_stat_button" icon="fa-paperclip">
              <field name="attachment_count" widget="statinfo" string="Adjuntos"/>
            </button>
          </div>

          <widget name="web_ribbon" title="Timbrado" bg_color="bg-success" invisible="state != 'stamped'"/>
          <widget name="web_ribbon" title="Cancelado" bg_color="bg-danger"  invisible="state != 'canceled'"/>

          <h1 class="factura-title">
            <field name="cliente_id" readonly="1"/>
            <span class="muted">/</span>
            <field name="tipo" readonly="1"/>
          </h1>

          <group>
            <group>
              <field name="empresa_id" required="1" readonly="state != 'draft'" options="{'no_open': True}"/>
              <field name="sucursal_id" required="1" readonly="state != 'draft'" options="{'no_open': True}"/>
              <field name="cliente_id"  readonly="state != 'draft'" options="{'no_open': True}"/>
              <field name="tipo"        readonly="state != 'draft'"/>
              <field name="egreso_tipo" invisible="tipo != 'E'"/>
              <field name="origin_factura_id" invisible="not (tipo == 'E' or tipo == 'P')"/>
              <field name="origin_move_id" invisible="tipo != 'E'" readonly="1"/>
            </group>
            <group>
              <field name="uso_cfdi" invisible="tipo == 'P'" readonly="state != 'draft'"/>
              <field name="metodo"   invisible="tipo == 'P'" readonly="state != 'draft'"/>
              <field name="forma"    invisible="tipo == 'P'" readonly="state != 'draft'"/>
              <field name="moneda"   readonly="state != 'draft'"/>
              <field name="fecha"    readonly="state != 'draft'"/>
            </group>
          </group>

          <group>
            <group>
              <field name="serie" readonly="state != 'draft'"/>
              <field name="folio" readonly="state != 'draft'"/>
            </group>
            <group>
              <field name="uuid" readonly="1"/>
              <field name="move_id" readonly="1"/>
              <field name="importe_total" readonly="1"/>
              <field name="saldo" readonly="1"/>
            </group>
          </group>

          <group string="Pago" invisible="tipo != 'P'">
            <group>
              <field name="pago_importe" required="1"/>
            </group>
            <group>
              <field name="forma" required="1" readonly="state != 'draft'"/>
              <field name="fecha" readonly="state != 'draft'"/>
            </group>
          </group>

          <notebook>
            <page string="Productos/Servicios" invisible="tipo == 'P'">
              <!-- Ingresos -->
              <field name="line_ids" readonly="state != 'draft'" invisible="tipo != 'I'">
                <list editable="bottom" create="state == 'draft'" delete="state == 'draft'">
                  <field name="line_type" required="1" readonly="source_model"/>
                  <field name="empresa_id" readonly="1"/>
                  <field name="cliente_id" readonly="1"/>
                  <field name="sale_id" readonly="1" invisible="parent.tipo == 'E'"/>
                  <field name="transaccion_id" readonly="1" invisible="parent.tipo == 'E'"/>
                  <field name="producto_id" readonly="source_model"/>
                  <field name="descripcion" readonly="source_model"/>
                  <field name="cantidad" readonly="source_model"/>
                  <field name="precio" readonly="source_model"/>
                  <field name="iva_ratio" readonly="source_model"/>
                  <field name="ieps_ratio" readonly="source_model"/>
                  <field name="subtotal" readonly="1" sum="Total"/>
                  <field name="iva_amount" readonly="1" sum="IVA"/>
                  <field name="ieps_amount" readonly="1" sum="IEPS"/>
                  <field name="total" readonly="1" sum="Total"/>
                </list>
              </field>

              <!-- Nota de crÃ©dito -->
              <field name="line_ids" readonly="state != 'draft'" invisible="not (tipo == 'E' and egreso_tipo == 'nc')" options="{'no_create': True, 'no_quick_create': True, 'no_create_edit': True}">
                <list editable="bottom" create="state == 'draft'" delete="state == 'draft'">
                  <field name="line_type" required="1" readonly="1"/>
                  <field name="empresa_id" readonly="1"/>
                  <field name="cliente_id" readonly="1"/>
                  <field name="sale_id" readonly="1" invisible="parent.tipo == 'E'"/>
                  <field name="transaccion_id" readonly="1" invisible="parent.tipo == 'E'"/>
                  <field name="producto_id" readonly="1"/>
                  <field name="descripcion" readonly="1"/>
                  <field name="cantidad" readonly="1"/>
                  <field name="precio"/>
                  <field name="iva_ratio"/>
                  <field name="ieps_ratio"/>
                  <field name="subtotal" readonly="1" sum="Total"/>
                  <field name="iva_amount" readonly="1" sum="IVA"/>
                  <field name="ieps_amount" readonly="1" sum="IEPS"/>
                  <field name="total" readonly="1" sum="Total"/>
                </list>
              </field>

              <!-- DevoluciÃ³n -->
              <field name="line_ids" readonly="state != 'draft'" invisible="not (tipo == 'E' and egreso_tipo == 'dev')" options="{'no_create': True, 'no_quick_create': True, 'no_create_edit': True}">
                <list editable="bottom" create="state == 'draft'" delete="state == 'draft'">
                  <field name="line_type" required="1" readonly="1"/>
                  <field name="empresa_id" readonly="1"/>
                  <field name="cliente_id" readonly="1"/>
                  <field name="producto_id" readonly="1"/>
                  <field name="descripcion" readonly="1"/>
                  <field name="cantidad"/>
                  <field name="precio" readonly="1"/>
                  <field name="iva_ratio" readonly="1"/>
                  <field name="ieps_ratio" readonly="1"/>
                  <field name="subtotal" readonly="1" sum="Total"/>
                  <field name="iva_amount" readonly="1" sum="IVA"/>
                  <field name="ieps_amount" readonly="1" sum="IEPS"/>
                  <field name="total" readonly="1" sum="Total"/>
                </list>
              </field>
            </page>

            <page string="Ventas seleccionadas" invisible="tipo != 'I'">
              <field name="venta_ids" widget="many2many_tags" readonly="state != 'draft'"/>
            </page>

            <page string="Adjuntos">
              <group>
                <button name="action_open_attachments" type="object" string="Ver todos los adjuntos" class="btn-primary"/>
                <button name="action_fetch_xml_from_sw" type="object" string="Recuperar XML desde PAC" class="btn-warning" invisible="not uuid"/>
              </group>
              <group>
                <field name="attachment_count" readonly="1"/>
              </group>
            </page>

            <page string="InformaciÃ³n tÃ©cnica">
              <group>
                <group string="CFDI">
                  <field name="uuid"/>
                  <field name="state"/>
                  <field name="move_id"/>
                </group>
                <group string="CompaÃ±Ã­as">
                  <field name="empresa_id"/>
                </group>
              </group>
            </page>
          </notebook>
        </sheet>
      </form>
    </field>
  </record>

  <!-- SEARCH: puedes aÃ±adir searchpanel si quieres -->
  <record id="view_factura_search18" model="ir.ui.view">
    <field name="name">facturas.factura.search18</field>
    <field name="model">facturas.factura</field>
    <field name="arch" type="xml">
      <search string="Buscar facturas">
        <field name="cliente_id"/>
        <field name="uuid"/>

        <filter name="tipo_I" string="Ingresos" domain="[('tipo','=','I')]"/>
        <filter name="tipo_E" string="Egresos"  domain="[('tipo','=','E')]"/>
        <filter name="tipo_P" string="Pagos"    domain="[('tipo','=','P')]"/>

        <filter name="st_draft"   string="Borrador"  domain="[('state','=','draft')]"/>
        <filter name="st_ready"   string="Listo"     domain="[('state','=','ready')]"/>
        <filter name="st_stamped" string="Timbrado"  domain="[('state','=','stamped')]"/>
        <filter name="st_cancel"  string="Cancelado" domain="[('state','=','canceled')]"/>

        <group expand="0" string="Fecha">
          <filter name="today"  string="Hoy" domain="[('fecha','>=', context_today())]"/>
          <filter name="last30" string="Ãšltimos 30 dÃ­as" domain="[('fecha','>=', (context_today() - relativedelta(days=30)))]"/>
        </group>

        <group expand="0" string="Agrupar por">
          <filter name="gb_cliente" string="Cliente" context="{'group_by':'cliente_id'}"/>
          <filter name="gb_estado"  string="Estado"  context="{'group_by':'state'}"/>
          <filter name="gb_tipo"    string="Tipo"    context="{'group_by':'tipo'}"/>
          <filter name="gb_mes"     string="Mes"     context="{'group_by':'fecha:month'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- ACTION: incluye KANBAN -->
  <record id="action_facturas_ui18" model="ir.actions.act_window">
    <field name="name">Interfaz de Facturas</field>
    <field name="res_model">facturas.factura</field>
    <field name="view_mode">kanban,list,form</field>
    <field name="context">{'default_tipo': 'I'}</field>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">Crea tu primera factura</p>
      <p>Administra facturas, notas de crÃ©dito y complementos de pago.</p>
    </field>
  </record>

</odoo>
